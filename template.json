{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"resources": [
      {
		"type": "Microsoft.Authorization/policyDefinitions",
		"apiVersion": "2019-09-01",
		"name": "enforceEnvironmentTag_via_ARM",
		"properties": {
			"displayName": "Enforce Environment Tag",
			"description": "This policy ensures that resources have an 'environment' tag with allowed values: Production, Development, or Test.",
			
				"mode": "All",
				"policyRule": {
					"if": {
						"allOf": [
                             {
								"field": "type",
								"equals": "Microsoft.Resources/subscriptions/resourceGroups"
							},
							{
								"not": {
									"field": "[concat('tags[', parameters('tagName'), ']')]",
									"in": "[parameters('listofallowedtagValues')]"
								}
							}
						]
					},
					"then": {
						"effect": "[parameters('effect')]"
					}
				},
				"parameters": {
					"effect": {
						"type": "String",
						"metadata": {
							"displayName": "Effect",
							"description": "Enable or disable the execution of the audit policy"
						},
						"allowedValues": [
							"Audit",
							"Deny",
							"Disabled"
						],
						"defaultValue": "Deny"
					},
					"tagName": {
						"type": "String",
						"metadata": {
							"displayName": "Tag Name",
							"description": "Name of the tag, such as 'environment'"
						},
						"defaultValue": "environment"
					},
					"listofallowedtagValues": {
						"type": "Array",
						"metadata": {
							"displayName": "Tag Values",
							"description": "Value of the tag, such as 'production'"
						},
						"allowedValues": [
							"development",
							"test",
							"production"
						]
					}
				}
			}
			}
]
}